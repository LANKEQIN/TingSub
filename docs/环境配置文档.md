# 汀阅（TingSub）环境配置文档

## 一、环境配置概述

### 1.1 配置原则
汀阅（TingSub）采用环境变量管理配置，确保不同环境（开发、测试、生产）的配置隔离和安全。

### 1.2 核心配置原则
1. **环境隔离**：不同环境使用不同的配置
2. **安全优先**：敏感信息使用环境变量存储
3. **配置集中**：所有配置集中管理
4. **类型安全**：使用TypeScript确保配置类型安全
5. **易于切换**：支持快速切换环境

## 二、开发环境配置

### 2.1 环境要求

#### 2.1.1 Node.js
- **版本要求**：Node.js 16.x LTS版本或更高
- **推荐版本**：Node.js 18.x LTS
- **安装方式**：
  - Windows：从[Node.js官网](https://nodejs.org/)下载安装包
  - macOS：使用Homebrew安装 `brew install node`
  - Linux：使用nvm安装 `nvm install 18`

#### 2.1.2 包管理器
- **npm**：7.x或更高版本（随Node.js安装）
- **yarn**：1.22.x或更高版本（推荐）
- **安装yarn**：
  ```bash
  npm install -g yarn
  ```

#### 2.1.3 Expo CLI
- **版本要求**：最新稳定版
- **安装方式**：
  ```bash
  yarn global add expo-cli
  ```

#### 2.1.4 React Native CLI
- **版本要求**：最新稳定版
- **安装方式**：
  ```bash
  yarn global add react-native-cli
  ```

#### 2.1.5 Android开发环境
- **JDK**：11或更高版本
- **Android Studio**：最新稳定版
- **Android SDK**：API Level 33（Android 13）或更高
- **安装方式**：
  1. 下载并安装[Android Studio](https://developer.android.com/studio)
  2. 打开Android Studio，安装Android SDK
  3. 配置环境变量`ANDROID_HOME`

#### 2.1.6 iOS开发环境（仅macOS）
- **Xcode**：13.0或更高版本
- **CocoaPods**：最新稳定版
- **安装方式**：
  ```bash
  # 安装Xcode（从App Store下载）
  
  # 安装CocoaPods
  sudo gem install cocoapods
  ```

### 2.2 环境变量配置

#### 2.2.1 环境变量文件
```bash
# .env.development
NODE_ENV=development
APP_NAME=汀阅
APP_VERSION=1.0.0

# API配置（后续版本）
API_BASE_URL=http://localhost:3000
API_TIMEOUT=10000

# 数据库配置
REALM_ENCRYPTION_KEY=development-encryption-key
REALM_SCHEMA_VERSION=1

# 功能开关
ENABLE_CLOUD_SYNC=false
ENABLE_ANALYTICS=false
ENABLE_CRASH_REPORTING=false

# 调试配置
DEBUG_MODE=true
LOG_LEVEL=debug
```

#### 2.2.2 环境变量类型定义
```typescript
// src/config/env.ts
interface EnvConfig {
  // 应用环境
  NODE_ENV: 'development' | 'production' | 'test';
  
  // 应用配置
  APP_NAME: string;
  APP_VERSION: string;
  
  // API配置
  API_BASE_URL: string;
  API_TIMEOUT: number;
  
  // 数据库配置
  REALM_ENCRYPTION_KEY: string;
  REALM_SCHEMA_VERSION: number;
  
  // 功能开关
  ENABLE_CLOUD_SYNC: boolean;
  ENABLE_ANALYTICS: boolean;
  ENABLE_CRASH_REPORTING: boolean;
  
  // 调试配置
  DEBUG_MODE: boolean;
  LOG_LEVEL: 'debug' | 'info' | 'warn' | 'error';
}

export const ENV: EnvConfig = {
  NODE_ENV: process.env.NODE_ENV || 'development',
  APP_NAME: process.env.APP_NAME || '汀阅',
  APP_VERSION: process.env.APP_VERSION || '1.0.0',
  API_BASE_URL: process.env.API_BASE_URL || 'http://localhost:3000',
  API_TIMEOUT: Number(process.env.API_TIMEOUT) || 10000,
  REALM_ENCRYPTION_KEY: process.env.REALM_ENCRYPTION_KEY || '',
  REALM_SCHEMA_VERSION: Number(process.env.REALM_SCHEMA_VERSION) || 1,
  ENABLE_CLOUD_SYNC: process.env.ENABLE_CLOUD_SYNC === 'true',
  ENABLE_ANALYTICS: process.env.ENABLE_ANALYTICS === 'true',
  ENABLE_CRASH_REPORTING: process.env.ENABLE_CRASH_REPORTING === 'true',
  DEBUG_MODE: process.env.DEBUG_MODE === 'true',
  LOG_LEVEL: (process.env.LOG_LEVEL as any) || 'debug',
};

// 环境判断
export const isDevelopment = ENV.NODE_ENV === 'development';
export const isProduction = ENV.NODE_ENV === 'production';
export const isTest = ENV.NODE_ENV === 'test';
```

### 2.3 开发环境安装步骤

#### 2.3.1 克隆项目
```bash
# 克隆项目仓库
git clone https://github.com/yourusername/TingSub.git

# 进入项目目录
cd TingSub
```

#### 2.3.2 安装依赖
```bash
# 使用yarn安装依赖（推荐）
yarn install

# 或使用npm安装依赖
npm install
```

#### 2.3.3 配置环境变量
```bash
# 复制环境变量模板
cp .env.example .env.development

# 编辑环境变量文件
# 根据需要修改配置
```

#### 2.3.4 启动开发服务器
```bash
# 启动Expo开发服务器
yarn start

# 或使用npm
npm start
```

#### 2.3.5 在模拟器或真机上运行
```bash
# iOS模拟器
yarn ios

# Android模拟器
yarn android

# 或使用Expo CLI
expo start --ios
expo start --android
```

### 2.4 开发工具配置

#### 2.4.1 VS Code配置
```json
// .vscode/settings.json
{
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  },
  "typescript.tsdk": "node_modules/typescript/lib",
  "typescript.enablePromptUseWorkspaceTsdk": true,
  "eslint.validate": [
    "javascript",
    "javascriptreact",
    "typescript",
    "typescriptreact"
  ],
  "[typescript]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[typescriptreact]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  }
}
```

#### 2.4.2 VS Code扩展推荐
```json
// .vscode/extensions.json
{
  "recommendations": [
    "dbaeumer.vscode-eslint",
    "esbenp.prettier-vscode",
    "ms-vscode.vscode-typescript-next",
    "dsznajder.es7-react-js-snippets",
    "bradlc.vscode-tailwindcss",
    "eamodio.gitlens"
  ]
}
```

## 三、生产环境配置

### 3.1 生产环境变量配置

#### 3.1.1 环境变量文件
```bash
# .env.production
NODE_ENV=production
APP_NAME=汀阅
APP_VERSION=1.0.0

# API配置（后续版本）
API_BASE_URL=https://api.tingsub.com
API_TIMEOUT=10000

# 数据库配置
REALM_ENCRYPTION_KEY=production-encryption-key
REALM_SCHEMA_VERSION=1

# 功能开关
ENABLE_CLOUD_SYNC=true
ENABLE_ANALYTICS=true
ENABLE_CRASH_REPORTING=true

# 调试配置
DEBUG_MODE=false
LOG_LEVEL=error
```

### 3.2 应用配置

#### 3.2.1 app.json配置
```json
{
  "expo": {
    "name": "汀阅",
    "slug": "tingsub",
    "version": "1.0.0",
    "orientation": "portrait",
    "icon": "./assets/icon.png",
    "userInterfaceStyle": "automatic",
    "splash": {
      "image": "./assets/splash.png",
      "resizeMode": "contain",
      "backgroundColor": "#FFFFFF"
    },
    "assetBundlePatterns": [
      "**/*"
    ],
    "ios": {
      "supportsTablet": true,
      "bundleIdentifier": "com.tingsub.app",
      "buildNumber": "1",
      "infoPlist": {
        "NSCameraUsageDescription": "需要相机权限",
        "NSPhotoLibraryUsageDescription": "需要相册权限"
      }
    },
    "android": {
      "adaptiveIcon": {
        "foregroundImage": "./assets/adaptive-icon.png",
        "backgroundColor": "#FFFFFF"
      },
      "package": "com.tingsub.app",
      "versionCode": 1,
      "permissions": [
        "INTERNET",
        "RECEIVE_BOOT_COMPLETED",
        "VIBRATE"
      ]
    },
    "web": {
      "bundler": "metro",
      "output": "static",
      "favicon": "./assets/favicon.png"
    },
    "plugins": [
      [
        "expo-notifications",
        {
          "icon": "./assets/notification-icon.png",
          "color": "#9ACFFF",
          "sounds": []
        }
      ]
    ],
    "experiments": {
      "typedRoutes": true
    },
    "extra": {
      "eas": {
        "projectId": "your-project-id"
      }
    },
    "updates": {
      "url": "https://u.expo.dev/your-project-id"
    },
    "runtimeVersion": {
      "policy": "appVersion"
    }
  }
}
```

#### 3.2.2 EAS Build配置
```json
{
  "cli": {
    "version": ">= 5.2.0"
  },
  "build": {
    "development": {
      "developmentClient": true,
      "distribution": "internal"
    },
    "preview": {
      "distribution": "internal",
      "android": {
        "buildType": "apk"
      },
      "ios": {
        "simulator": false
      }
    },
    "production": {
      "ios": {
        "autoIncrement": true
      },
      "android": {
        "buildType": "app-bundle"
      }
    }
  },
  "submit": {
    "production": {
      "ios": {
        "appleId": "your-apple-id",
        "ascAppId": "your-app-specific-id",
        "appleTeamId": "your-team-id"
      },
      "android": {
        "serviceAccountKeyPath": "./google-service-account.json",
        "track": "production"
      }
    }
  }
}
```

### 3.3 生产环境构建

#### 3.3.1 构建前准备
```bash
# 1. 登录Expo账户
expo login

# 2. 配置EAS Build
eas build:configure

# 3. 验证配置
eas build --platform ios --profile production --non-interactive
```

#### 3.3.2 构建iOS应用
```bash
# 构建iOS应用（生产环境）
eas build --platform ios --profile production

# 构建iOS应用（预览环境）
eas build --platform ios --profile preview

# 构建iOS应用（开发环境）
eas build --platform ios --profile development
```

#### 3.3.3 构建Android应用
```bash
# 构建Android应用（生产环境）
eas build --platform android --profile production

# 构建Android应用（预览环境）
eas build --platform android --profile preview

# 构建Android应用（开发环境）
eas build --platform android --profile development
```

### 3.4 生产环境优化

#### 3.4.1 代码压缩
```javascript
// metro.config.js
const { getDefaultConfig } = require('expo/metro-config');

const config = getDefaultConfig(__dirname);

// 启用代码压缩
config.transformer.minifierConfig = {
  enable: true,
  keep_classnames: false,
  keep_fnames: false,
  mangle: {
    keep_fnames: false,
  },
};

module.exports = config;
```

#### 3.4.2 资源优化
```json
// app.json
{
  "expo": {
    "assetBundlePatterns": [
      "assets/images/**",
      "assets/fonts/**"
    ]
  }
}
```

#### 3.4.3 包体积优化
```javascript
// babel.config.js
module.exports = function(api) {
  api.cache(true);
  
  return {
    presets: ['babel-preset-expo'],
    plugins: [
      // 移除未使用的代码
      'transform-remove-console',
      // 优化导入
      'babel-plugin-transform-imports',
    ],
  };
};
```

#### 3.4.4 性能优化
```json
// app.json
{
  "expo": {
    "jsEngine": "hermes",
    "packagerOpts": {
      "config": "metro.config.js",
      "assetExts": [
        "png",
        "jpg",
        "jpeg",
        "gif",
        "webp",
        "svg"
      ]
    }
  }
}
```

### 3.5 生产环境部署

#### 3.5.1 iOS部署
```bash
# 提交到App Store
eas submit --platform ios --profile production

# 或手动提交
# 1. 下载构建的.ipa文件
# 2. 使用Application Loader或Xcode上传到App Store Connect
# 3. 填写应用信息并提交审核
```

#### 3.5.2 Android部署
```bash
# 提交到Google Play Store
eas submit --platform android --profile production

# 或手动提交
# 1. 下载构建的.aab文件
# 2. 登录Google Play Console
# 3. 创建新版本并上传.aab文件
# 4. 填写应用信息并发布
```

## 四、测试环境配置

### 4.1 测试环境变量配置

#### 4.1.1 环境变量文件
```bash
# .env.test
NODE_ENV=test
APP_NAME=汀阅
APP_VERSION=1.0.0

# API配置
API_BASE_URL=http://localhost:3000
API_TIMEOUT=10000

# 数据库配置
REALM_ENCRYPTION_KEY=test-encryption-key
REALM_SCHEMA_VERSION=1

# 功能开关
ENABLE_CLOUD_SYNC=false
ENABLE_ANALYTICS=false
ENABLE_CRASH_REPORTING=false

# 调试配置
DEBUG_MODE=true
LOG_LEVEL=debug
```

### 4.2 测试配置

#### 4.2.1 Jest配置
```javascript
// jest.config.js
module.exports = {
  preset: 'jest-expo',
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
  testMatch: ['**/__tests__/**/*.test.[jt]s?(x)'],
  collectCoverageFrom: [
    'src/**/*.{js,jsx,ts,tsx}',
    '!src/**/*.d.ts',
    '!src/**/*.stories.{js,jsx,ts,tsx}',
    '!src/**/{index,constants,types}.{js,jsx,ts,tsx}',
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
  moduleFileExtensions: ['ts', 'tsx', 'js', 'jsx', 'json', 'node'],
  transformIgnorePatterns: [
    'node_modules/(?!((jest-)?react-native|@react-native(-community)?)|expo(nent)?|@expo(nent)?/.*|@expo-google-fonts/.*|react-navigation|@react-navigation/.*|@unimodules/.*|native-base|@native-base/.*|react-native-vector-icons)',
  ],
};
```

#### 4.2.2 测试设置
```javascript
// jest.setup.js
import '@testing-library/jest-native/extend-expect';
import { configure } from '@testing-library/react-native';

// 配置测试库
configure({
  asyncUtilTimeout: 10000,
});

// 模拟导航
jest.mock('@react-navigation/native', () => ({
  useNavigation: () => ({
    navigate: jest.fn(),
    goBack: jest.fn(),
    reset: jest.fn(),
  }),
  useRoute: () => ({
    params: {},
  }),
}));

// 模拟AsyncStorage
jest.mock('@react-native-async-storage/async-storage', () => ({
  setItem: jest.fn(),
  getItem: jest.fn(),
  removeItem: jest.fn(),
  clear: jest.fn(),
  getAllKeys: jest.fn(),
  multiGet: jest.fn(),
  multiSet: jest.fn(),
  multiRemove: jest.fn(),
}));
```

### 4.3 运行测试

#### 4.3.1 运行所有测试
```bash
# 运行所有测试
yarn test

# 或使用npm
npm test
```

#### 4.3.2 运行特定测试
```bash
# 运行特定测试文件
yarn test SubscriptionList.test.tsx

# 运行匹配模式的测试
yarn test --testNamePattern="订阅"
```

#### 4.3.3 生成测试覆盖率报告
```bash
# 生成测试覆盖率报告
yarn test --coverage

# 查看覆盖率报告
open coverage/lcov-report/index.html
```

## 五、环境切换

### 5.1 环境切换方法

#### 5.1.1 使用环境变量文件
```bash
# 开发环境
cp .env.development .env

# 测试环境
cp .env.test .env

# 生产环境
cp .env.production .env
```

#### 5.1.2 使用脚本切换
```json
// package.json
{
  "scripts": {
    "start:dev": "cp .env.development .env && expo start",
    "start:test": "cp .env.test .env && expo start",
    "start:prod": "cp .env.production .env && expo start",
    "test:dev": "cp .env.development .env && jest",
    "test:test": "cp .env.test .env && jest",
    "build:ios:dev": "cp .env.development .env && eas build --platform ios --profile development",
    "build:ios:prod": "cp .env.production .env && eas build --platform ios --profile production",
    "build:android:dev": "cp .env.development .env && eas build --platform android --profile development",
    "build:android:prod": "cp .env.production .env && eas build --platform android --profile production"
  }
}
```

### 5.2 环境检测

#### 5.2.1 环境检测工具
```typescript
// src/utils/envUtils.ts
import { ENV, isDevelopment, isProduction, isTest } from '../config/env';

export class EnvUtils {
  /**
   * 获取当前环境
   */
  static getEnv(): 'development' | 'production' | 'test' {
    return ENV.NODE_ENV;
  }

  /**
   * 是否为开发环境
   */
  static isDev(): boolean {
    return isDevelopment;
  }

  /**
   * 是否为生产环境
   */
  static isProd(): boolean {
    return isProduction;
  }

  /**
   * 是否为测试环境
   */
  static isTestEnv(): boolean {
    return isTest;
  }

  /**
   * 是否启用调试模式
   */
  static isDebugMode(): boolean {
    return ENV.DEBUG_MODE;
  }

  /**
   * 获取日志级别
   */
  static getLogLevel(): string {
    return ENV.LOG_LEVEL;
  }

  /**
   * 是否启用云同步
   */
  static isCloudSyncEnabled(): boolean {
    return ENV.ENABLE_CLOUD_SYNC;
  }

  /**
   * 是否启用分析
   */
  static isAnalyticsEnabled(): boolean {
    return ENV.ENABLE_ANALYTICS;
  }

  /**
   * 是否启用崩溃报告
   */
  static isCrashReportingEnabled(): boolean {
    return ENV.ENABLE_CRASH_REPORTING;
  }
}
```

## 六、常见问题排查

### 6.1 环境配置问题

#### 6.1.1 环境变量未生效
**问题**：修改环境变量后未生效

**解决方案**：
```bash
# 1. 重启开发服务器
yarn start --clear

# 2. 清除缓存
expo start -c

# 3. 重新安装依赖
rm -rf node_modules
yarn install
```

#### 6.1.2 环境变量读取失败
**问题**：无法读取环境变量

**解决方案**：
```typescript
// 检查环境变量文件是否存在
import { existsSync } from 'fs';
import path from 'path';

const envPath = path.join(__dirname, '.env');
if (!existsSync(envPath)) {
  console.warn('环境变量文件不存在');
}

// 使用dotenv加载环境变量
import dotenv from 'dotenv';
dotenv.config();
```

### 6.2 构建问题

#### 6.2.1 构建失败
**问题**：EAS Build构建失败

**解决方案**：
```bash
# 1. 检查EAS配置
eas build:configure

# 2. 验证构建配置
eas build --platform ios --profile production --non-interactive

# 3. 查看构建日志
eas build --platform ios --profile production --local

# 4. 清除缓存
eas build --platform ios --profile production --clear-cache
```

#### 6.2.2 依赖冲突
**问题**：依赖版本冲突导致构建失败

**解决方案**：
```bash
# 1. 清除依赖
rm -rf node_modules
rm yarn.lock

# 2. 重新安装依赖
yarn install

# 3. 检查依赖冲突
yarn why <package-name>

# 4. 使用 resolutions解决冲突
# 在package.json中添加resolutions字段
```

### 6.3 运行时问题

#### 6.3.1 应用启动失败
**问题**：应用无法启动

**解决方案**：
```bash
# 1. 清除Expo缓存
expo r -c

# 2. 重置开发服务器
expo start --clear

# 3. 检查端口占用
# Windows
netstat -ano | findstr :19000

# macOS/Linux
lsof -i :19000

# 4. 更新Expo CLI
yarn global add expo-cli@latest
```

#### 6.3.2 模拟器连接问题
**问题**：无法连接到模拟器

**解决方案**：
```bash
# 1. 检查模拟器是否运行
# iOS
xcrun simctl list devices

# Android
adb devices

# 2. 重启模拟器
# iOS
xcrun simctl shutdown all

# Android
adb emu kill

# 3. 重新启动应用
yarn start --clear
```

## 七、附录

### 7.1 环境变量速查表
| 变量名 | 说明 | 开发环境 | 生产环境 |
| --- | --- | --- | --- |
| NODE_ENV | 应用环境 | development | production |
| APP_NAME | 应用名称 | 汀阅 | 汀阅 |
| APP_VERSION | 应用版本 | 1.0.0 | 1.0.0 |
| API_BASE_URL | API基础URL | http://localhost:3000 | https://api.tingsub.com |
| API_TIMEOUT | API超时时间 | 10000 | 10000 |
| REALM_ENCRYPTION_KEY | 数据库加密密钥 | development-key | production-key |
| ENABLE_CLOUD_SYNC | 云同步开关 | false | true |
| ENABLE_ANALYTICS | 分析开关 | false | true |
| ENABLE_CRASH_REPORTING | 崩溃报告开关 | false | true |
| DEBUG_MODE | 调试模式 | true | false |
| LOG_LEVEL | 日志级别 | debug | error |

### 7.2 常用命令速查表
| 命令 | 说明 |
| --- | --- |
| `yarn start` | 启动开发服务器 |
| `yarn ios` | 在iOS模拟器运行 |
| `yarn android` | 在Android模拟器运行 |
| `yarn test` | 运行测试 |
| `eas build --platform ios` | 构建iOS应用 |
| `eas build --platform android` | 构建Android应用 |
| `eas submit --platform ios` | 提交iOS应用到App Store |
| `eas submit --platform android` | 提交Android应用到Google Play |
| `expo r -c` | 清除Expo缓存 |
| `expo start --clear` | 清除缓存并启动 |

### 7.3 参考资料
- [Expo 官方文档](https://docs.expo.dev/)
- [EAS Build 文档](https://docs.expo.dev/build/introduction/)
- [React Native 官方文档](https://reactnative.dev/)
- [Node.js 官方文档](https://nodejs.org/docs/)
- [Yarn 官方文档](https://yarnpkg.com/getting-started)
